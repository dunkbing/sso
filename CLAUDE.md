# SSO System

Centralized SSO authentication API serving multiple web apps across subdomains and mobile apps.

## Tech Stack

- **Runtime:** Bun (VPS) / Cloudflare Workers
- **Framework:** Hono
- **Auth:** Better Auth (email/password, cross-subdomain cookies)
- **ORM:** Drizzle ORM
- **Database:** PostgreSQL (Neon)
- **DB Driver:** `bun:sql` (VPS) / `postgres` (CF Workers)

## Project Structure

```
src/
├── index.ts              # VPS entry point (Bun)
├── worker.ts             # CF Workers entry point
├── lib/
│   ├── auth-options.ts   # Shared auth options + AuthEnv type
│   ├── auth.ts           # VPS auth (singleton, bun:sql)
│   ├── auth.worker.ts    # CF auth (factory, postgres.js)
│   └── db.ts             # VPS db connection (bun:sql)
└── db/
    └── schema.ts         # Shared Drizzle schema (generated by Better Auth CLI)
wrangler.toml             # CF Workers config
drizzle.config.ts         # Drizzle Kit config
drizzle/                  # Generated migration SQL files
```

## Commands

### VPS (Bun)
- `bun run dev` — Start dev server with hot reload (port 3000)
- `bun run src/index.ts` — Start server

### CF Workers
- `bun run dev:worker` — Local dev with wrangler (uses `.dev.vars` for env)
- `bun run deploy:worker` — Deploy to Cloudflare Workers
- `wrangler secret put <KEY>` — Set production secrets

### Shared
- `bunx tsc --noEmit` — Type check
- `bunx drizzle-kit generate` — Generate migration files from schema changes
- `bunx drizzle-kit migrate` — Apply migrations to database
- `bunx @better-auth/cli@latest generate --config ./src/lib/auth.ts --output ./src/db/schema.ts` — Regenerate Better Auth schema (run after adding plugins)

## Architecture

- Two deployment targets (VPS + CF Workers) sharing the same PostgreSQL database
- VPS: singleton auth instance, `bun:sql` driver, `process.env`
- CF Workers: auth factory per-request via `auth(c.env)`, `postgres` (postgres.js) driver, `c.env` bindings
- Shared auth options extracted to `auth-options.ts` with `AuthEnv` interface
- Better Auth handles all auth logic via `/api/auth/*` routes
- Auth handler receives raw `Request` objects: `auth.handler(c.req.raw)`
- Drizzle adapter requires schema passed to the `drizzle()` instance (not just the adapter config)
- CORS and cross-subdomain cookies driven by `AUTH_DOMAIN` and `CORS_ORIGINS` env vars; localhost is always allowed
- Mobile clients use `Authorization: Bearer <token>` header (same endpoints)
- Session cookie caching enabled (5 min) to reduce DB lookups

## Environment Variables

- `DATABASE_URL` — PostgreSQL connection string
- `BETTER_AUTH_SECRET` — Auth encryption secret (min 32 chars)
- `BETTER_AUTH_URL` — Base URL for auth callbacks (e.g., `http://localhost:3000`)
- `AUTH_DOMAIN` — Cookie domain for cross-subdomain SSO (e.g., `.example.com`)
- `CORS_ORIGINS` — Comma-separated trusted origins for Better Auth (e.g., `https://*.example.com`)

## Key Gotchas

- Always pass `schema` to `drizzle()` in `db.ts` — the Better Auth adapter reads it from `db._.fullSchema`
- After adding Better Auth plugins, re-run the CLI to regenerate `src/db/schema.ts`, then generate and apply new migrations
- `AUTH_DOMAIN` is used by both CORS (`index.ts`) and cross-subdomain cookies (`auth.ts`) — keep them consistent via the single env var
- Cookie cache means revoked sessions stay active on other devices for up to `maxAge` (5 min)
