# SSO System

Centralized SSO authentication API serving multiple web apps across subdomains and mobile apps.

## Tech Stack

- **Runtime:** Bun (VPS) / Cloudflare Workers
- **Framework:** Hono
- **Auth:** Better Auth (email/password, cross-subdomain cookies)
- **ORM:** Drizzle ORM
- **Database:** PostgreSQL via `bun:sql` (VPS) / Cloudflare D1 (CF Workers)

## Project Structure

```
src/
├── index.ts              # VPS entry point (Bun)
├── worker.ts             # CF Workers entry point
├── lib/
│   ├── auth-options.ts   # Shared auth options + AuthEnv type
│   ├── auth.ts           # VPS auth (singleton, bun:sql)
│   ├── auth.worker.ts    # CF auth (factory, D1)
│   └── db.ts             # VPS db connection (bun:sql)
└── db/
    ├── schema.ts         # PostgreSQL schema (generated by Better Auth CLI)
    └── schema.d1.ts      # D1/SQLite schema (mirrors schema.ts)
wrangler.toml             # CF Workers config
drizzle.config.ts         # Drizzle Kit config (PostgreSQL)
drizzle.d1.config.ts      # Drizzle Kit config (D1/SQLite)
drizzle/                  # Generated migration SQL files
```

## Commands

### VPS (Bun)
- `bun run dev` — Start dev server with hot reload (port 3000)
- `bun run src/index.ts` — Start server

### CF Workers
- `bun run dev:worker` — Local dev with wrangler (uses `.dev.vars` for env)
- `bun run deploy:worker` — Deploy to Cloudflare Workers
- `wrangler secret put <KEY>` — Set production secrets
- `wrangler d1 create sso-auth` — Create D1 database
- `wrangler d1 migrations apply sso-auth --remote` — Apply D1 migrations in production
- `wrangler d1 migrations apply sso-auth --local` — Apply D1 migrations locally

### Database Migrations
- `bunx drizzle-kit generate` — Generate PostgreSQL migrations
- `bunx drizzle-kit migrate` — Apply PostgreSQL migrations
- `bunx drizzle-kit generate --config drizzle.d1.config.ts` — Generate D1 migrations

### Schema Generation
- `bunx @better-auth/cli@latest generate --config ./src/lib/auth.ts --output ./src/db/schema.ts` — Regenerate Better Auth schema (run after adding plugins, then manually update `schema.d1.ts` to match)

## Architecture

- Two independent deployment targets with separate databases
- VPS: singleton auth instance, `bun:sql` driver, PostgreSQL, `process.env`
- CF Workers: auth factory per-request via `auth(c.env)`, D1 (SQLite), `c.env` bindings
- Shared auth options extracted to `auth-options.ts` with `AuthEnv` interface
- Better Auth handles all auth logic via `/api/auth/*` routes
- Auth handler receives raw `Request` objects: `auth.handler(c.req.raw)`
- CORS and cross-subdomain cookies driven by `AUTH_DOMAIN` and `CORS_ORIGINS` env vars; localhost is always allowed
- Mobile clients use `Authorization: Bearer <token>` header (same endpoints)
- Session cookie caching enabled (5 min) to reduce DB lookups

## Environment Variables

### VPS (.env)
- `DATABASE_URL` — PostgreSQL connection string
- `BETTER_AUTH_SECRET` — Auth encryption secret (min 32 chars)
- `BETTER_AUTH_URL` — Base URL for auth callbacks (e.g., `http://localhost:3000`)
- `AUTH_DOMAIN` — Cookie domain for cross-subdomain SSO (e.g., `.example.com`)
- `CORS_ORIGINS` — Comma-separated trusted origins (e.g., `https://*.example.com`)

### CF Workers (wrangler secrets + D1 binding)
- `BETTER_AUTH_SECRET` — Auth encryption secret (min 32 chars)
- `BETTER_AUTH_URL` — Base URL (e.g., `https://sso.example.com`)
- `AUTH_DOMAIN` — Cookie domain for cross-subdomain SSO
- `CORS_ORIGINS` — Comma-separated trusted origins
- `DB` — D1 database binding (configured in `wrangler.toml`)

## Key Gotchas

- Always pass `schema` to `drizzle()` — the Better Auth adapter reads it from `db._.fullSchema`
- After adding Better Auth plugins, re-run the CLI to regenerate `src/db/schema.ts`, then manually update `src/db/schema.d1.ts` to match (pg-core → sqlite-core, timestamp → integer with mode "timestamp")
- `AUTH_DOMAIN` is used by both CORS and cross-subdomain cookies — keep them consistent via the single env var
- Cookie cache means revoked sessions stay active on other devices for up to `maxAge` (5 min)
- VPS and CF Workers have separate user databases — they are independent deployments
